{% extends 'base.html' %}
{% block title %}Trade page{% endblock %}
{% block content %}
<div class="container">
<form action="" method="POST">
    {{form.hidden_tag()}}
    <div>
        {{ form.symbol.label }}
        {{ form.symbol(size=20, id="symbol-input") }}
    </div>

    <p id="price-display" style="font-weight:bold;"></p>
    <p id="loading-indicator" style="display:none; color:orange;">‚è≥ Loading mappings‚Ä¶</p>
    <p id="error-message" style="display:none; color:red;">‚ùå Price not found.</p>
    <div>
        {{ form.quantity.label }}
        {{ form.quantity(size=20) }}
    </div>

    <div>
        {{ form.trade_type.label }}
        {{ form.trade_type() }}
    </div>
    {{form.submit()}}
</form>
</div>
<script>
document.getElementById("symbol-input").addEventListener("change", function() {
    const symbol = this.value;
    const priceDisplay = document.getElementById("price-display");
    const loadingIndicator = document.getElementById("loading-indicator");
    const errorMessage = document.getElementById("error-message");

    // Reset UI
    priceDisplay.textContent = "";
    errorMessage.style.display = "none";
    loadingIndicator.style.display = "none";

    if (symbol) {
        // Show loading
        loadingIndicator.style.display = "block";

        fetch(`/get_price/${symbol}`)
            .then(res => res.json())
            .then(data => {
                // Hide loading
                loadingIndicator.style.display = "none";

                // if (!data.mappings_ready) {
                //     loadingIndicator.textContent = "‚è≥ Still preparing mappings‚Ä¶ try again shortly";
                //     loadingIndicator.style.display = "block";     
                // }
                
                if (data.price) {
                    priceDisplay.textContent = `üí∞ Live Price: $${data.price} (${data.market_type})`;
                } else {
                    errorMessage.style.display = "block";
                
            }
            })
            .catch(err => {
                loadingIndicator.style.display = "none";
                errorMessage.style.display = "block";
                console.error(err);
            });
    }
});
</script>
{% endblock %}
